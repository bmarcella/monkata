apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak-deployment
  labels:
    app: keycloak
spec:
  replicas: 1 
  selector:
    matchLabels:
      app: keycloak
  template:
   metadata:
     labels:
       app: keycloak
   spec:
      containers:
      - name: keycloak
        image: quay.io/keycloak/keycloak:23.0.1
        args: ["start"]
        ports:
          - containerPort: 8080
       # GOOD   
        env:
        - name: KC_DB
          value: "postgres"

        - name: KC_DB_URL
          valueFrom: 
            configMapKeyRef:
              name: monkata-configmap
              key: KC_DB_URL

        - name: KC_DB_URL_HOST
          valueFrom: 
            configMapKeyRef:
              name: monkata-configmap
              key: DB_HOST

        - name: KC_DB_URL_PORT
          valueFrom: 
            configMapKeyRef:
              name: monkata-configmap
              key: DB_PORT

        - name: POSTGRES_DB
          valueFrom: 
            configMapKeyRef:
              name: monkata-configmap
              key: DB_KC_NAME

        - name: KC_DB_URL_DATABASE
          valueFrom: 
            configMapKeyRef:
              name: monkata-configmap
              key: DB_KC_NAME
             
        # GOOD
        - name: KC_DB_USERNAME
          valueFrom:
            configMapKeyRef:
              name: monkata-configmap
              key: DB_USER

        - name: KC_DB_PASSWORD
          valueFrom:
            configMapKeyRef:
              name: monkata-configmap
              key: DB_PASSWORD

        - name: JAVA_OPTS
          value: -Dkeycloak.profile.feature.account_api=enabled
      #-name: KC_HOSTNAME_STRICT
          #value: "false"
        - name: KC_HEALTH_ENABLED
          value: "true"
        - name: KC_METRICS_ENABLED
          value: "true"
        - name: KC_LOG_LEVEL
          value: INFO  
        - name: KEYCLOAK_ADMIN
          valueFrom: 
            configMapKeyRef:
              name: monkata-configmap
              key: KEYCLOAK_ADMIN 
        - name: KEYCLOAK_ADMIN_PASSWORD
          valueFrom: 
            configMapKeyRef:
              name: monkata-configmap
              key: KEYCLOAK_ADMIN_PASSWORD
---       
apiVersion: v1
kind: Service 
metadata: 
  name: keycloak-service
spec:
  selector:
    app: keycloak
  type: LoadBalancer
  ports:
    - protocol: TCP
      port: 7878
      targetPort: 8080
